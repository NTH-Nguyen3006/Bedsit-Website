<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" layout:decorate="~{admin/base.html}">

<head>
    <title layout:title-pattern="$CONTENT_TITLE">Admin | Thêm phòng</title>
    <script src="https://cdn.tiny.cloud/1/cysxosndxu60zk3yax2kz9u6hjmdn0cuxw0ipk9ajny70m7e/tinymce/8/tinymce.min.js"
        referrerpolicy="origin" crossorigin="anonymous"></script>
    <!-- <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" /> -->
</head>

<div class="container-xxl" layout:fragment="admin-main-content">
    <div class="d-flex mt-5 align-items-center">
        <h1 class="text-uppercase fw-bolder">thêm phòng trọ</h1>
    </div>
    <hr class="mt-0">

    <p class="fw-bold">Thêm Hình Ảnh Mô Tả:</p>
    <div class="mb-5 g-2 row" id="upload-images-box">
        <div class="col-lg-2 col-md-3 col-sm-6">
            <div class="shadow rounded-3 position-relative" id="upload-image-box"
                style="cursor: pointer; width: 100%; height: 140px; max-width: 200px; border: 2px solid #b3b3b3;">
                <img class="position-absolute end-50" th:src="@{/images/icons/plus-gadient.png}" width="100"
                    style="transform: translate(50%, 15px);">
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-2 col-sm-12 mb-3">
            <label class="fw-bold" for="room-id">Mã nhận diện </label>
            <input class="form-control" type="text" id="room-id">
        </div>
        <div class="col-lg-2 col-sm-12 mb-3">
            <label class="fw-bold" for="area">Diện tích (m<sup>2</sup>)</label>
            <input class="form-control" type="number" id="area">
        </div>
        <div class="col-lg-3 col-sm-12 mb-3">
            <label class="fw-bold" for="room-type">Mô Tả Kiểu Phòng</label>
            <input class="form-control" type="text" id="room-type">
        </div>
        <div class="col-lg-3 col-sm-12 mb-3">
            <label class="fw-bold" for="rent-price">Giá Thuê (VNĐ)</label>
            <input class="form-control" type="number" id="rent-price">
        </div>
        <div class="col-lg-2 col-sm-12 mb-3">
            <label class="fw-bold" for="room-status">Trạng thái</label>
            <select class="form-select" id="room-status" aria-label="Default select example">
                <option value="0" selected>Chưa thuê</option>
                <option value="1">Đã Thuê</option>
                <option value="2">Đang sửa chửa</option>
            </select>
        </div>

        <div class="col-12 mb-3">
            <label class="fw-bold" for="description">Viết Mô Tả</label>
            <textarea name="description" id="description"></textarea>
        </div>

        <div class="">
            <button class="btn btn-secondary me-3">Hủy</button>
            <button class="btn btn-success" id="save-btn">Lưu</button>
        </div>
    </div>
    <br><br>

    <div layout:fragment="script-block">
        <script src="https://cdn.tiny.cloud/1/cysxosndxu60zk3yax2kz9u6hjmdn0cuxw0ipk9ajny70m7e/tinymce/8/tinymce.min.js"
            referrerpolicy="origin" crossorigin="anonymous"></script>
        <script>
            tinymce.init({
                selector: 'textarea',
                toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table mergetags | addcomment showcomments | spellcheckdialog a11ycheck typography | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat',
            });

            function fileChooser() {
                const inputFile = document.createElement("input");
                inputFile.type = "file";
                inputFile.accept = "image/*";
                inputFile.multiple = true;
                inputFile.onchange = (e) => {
                    for (const file of e.target.files) {
                        images.push(file);

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const imageUploadHtml = `<div class="col-lg-2 col-md-3 col-sm-6">
                            <div class="shadow rounded-3" id="upload-images-box"
                                style="cursor: pointer; width: 100%; height: 140px; max-width: 200px; border: 2px solid #b3b3b3;">
                                <img src="${e.target.result}" class="w-100 h-100">
                            </div>
                        </div>`;

                            const imageUploadElement = new DOMParser().parseFromString(
                                imageUploadHtml, "text/html").body.firstChild;
                            const uploadImgBox = document.getElementById("upload-images-box");
                            uploadImgBox.prepend(imageUploadElement);
                        }

                        reader.readAsDataURL(file);

                    }
                };
                inputFile.click();
            }

            const images = [];
            document.getElementById("upload-image-box").addEventListener("click", fileChooser);

            window.addEventListener("load", () => { // Kích hoạt khi web load xong hết
                document.getElementsByClassName("tox-statusbar")[0].classList.add("d-none");
            });

            document.getElementById("save-btn").addEventListener("click", () => {
                const roomId = document.getElementById("room-id").value;
                const roomType = document.getElementById("room-type").value;
                const roomArea = document.getElementById("area").value;
                const rentPrice = document.getElementById("room-type").value;
                const decription = tinymce.activeEditor.getContent();
                const roomStatus = document.getElementById("room-status").value;
                const data = new FormData();

                data.append("roomId", roomId);
                data.append("roomType", roomType);
                data.append("area", roomArea);
                data.append("rentPrice", rentPrice);
                data.append("description", description);
                data.append("status", roomStatus);

                images.forEach(img => data.append("images", img));


                fetch('/admin/room/create', { // Tạo một endpoint mới để xử lý FormData
                    method: 'POST',
                    // 'Content-Type' header khg cần thiết khi dùng FormData,
                    // headers: {
                    // },
                    // trình duyệt sẽ tự động thêm nó với boundary thích hợp.
                    body: data,
                })
                    .then(response => {
                        alert("Gửi dữ liệu thành công")
                    })
                    .catch(error => {
                        alert(error)
                    });


            });

        </script>
    </div>
</div>

</html>